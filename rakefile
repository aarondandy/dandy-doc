require 'albacore'

def extract_assembly_version(filePath)
	File.open(filePath,'r') do |file|
		file.each_line do |line|
			current_line = line.strip
			line_match = /.*AssemblyVersion[(]\s*\"(\d+[.]\d+[.]\d+)[.].*\".*/.match(current_line)
			if(line_match) then return line_match[1] end
		end
	end
	nil
end

def extract_cecil_version(filePath)
	File.open(filePath,'r') do |file|
		file.each_line do |line|
			current_line = line.strip
			line_match = /.*<package id=\"Mono.Cecil\" version=\"([^\"]+)\".*/.match(current_line)
			if(line_match) then return line_match[1] end
		end
	end
	nil
end

task :default => [:build,:make_nupkg]

task :make_nupkg => [:make_nupkg_core,:make_nupkg_core_cecil,:make_nupkg_code_doc,:make_nupkg_code_doc_cecil]

task :push_nupkg => [:push_nupkg_core,:push_nupkg_core_cecil,:push_nupkg_code_doc,:push_nupkg_code_doc_cecil]

msbuild :build do |msb|
	msb.targets = [:Clean, :Build]
	msb.solution = "./dandy-doc.sln"
	msb.properties = {:configuration => :Release}
end

exec :make_nupkg_core do |cmd|
	asmVersion3 = extract_assembly_version "./CommonAssemblyInfo.cs"
	puts "Version: #{asmVersion3}"
	cmd.command = "./.nuget/nuget.exe"
	cmd.parameters = "pack build/DandyDoc.Core.nuspec -Verbosity detailed -Version #{asmVersion3} -Symbols -OutputDirectory ./build/packed/ -Properties Configuration=Release"
	puts cmd.parameters
end

exec :push_nupkg_core do |cmd|
	asmVersion3 = extract_assembly_version "./CommonAssemblyInfo.cs"
	puts "Version: #{asmVersion3}"
	cmd.command = "./.nuget/nuget.exe"
	cmd.parameters = "push ./build/packed/DandyDoc.Core.#{asmVersion3}.nupkg"
	puts cmd.parameters
end

exec :make_nupkg_core_cecil do |cmd|
	asmVersion3 = extract_assembly_version "./CommonAssemblyInfo.cs"
	puts "Version: #{asmVersion3}"
	cecilVersion = extract_cecil_version "./src/DandyDoc.Core.Cecil/packages.config"
	puts "Cecil Version: #{cecilVersion}"
	cmd.command = "./.nuget/nuget.exe"
	cmd.parameters = "pack build/DandyDoc.Core.Cecil.nuspec -Verbosity detailed -Version #{asmVersion3} -Symbols -OutputDirectory ./build/packed/ -Properties Configuration=Release;cecilVersion=#{cecilVersion}"
end

exec :push_nupkg_core_cecil do |cmd|
	asmVersion3 = extract_assembly_version "./CommonAssemblyInfo.cs"
	puts "Version: #{asmVersion3}"
	cmd.command = "./.nuget/nuget.exe"
	cmd.parameters = "push build/packed/DandyDoc.Core.Cecil.#{asmVersion3}.nupkg"
	puts cmd.parameters
end

exec :make_nupkg_code_doc do |cmd|
	asmVersion3 = extract_assembly_version "./CommonAssemblyInfo.cs"
	puts "Version: #{asmVersion3}"
	cmd.command = "./.nuget/nuget.exe"
	cmd.parameters = "pack build/DandyDoc.CodeDoc.nuspec -Verbosity detailed -Version #{asmVersion3} -Symbols -OutputDirectory ./build/packed/ -Properties Configuration=Release"
	puts cmd.parameters
end

exec :push_nupkg_code_doc do |cmd|
	asmVersion3 = extract_assembly_version "./CommonAssemblyInfo.cs"
	puts "Version: #{asmVersion3}"
	cmd.command = "./.nuget/nuget.exe"
	cmd.parameters = "push build/packed/DandyDoc.CodeDoc.#{asmVersion3}.nupkg"
	puts cmd.parameters
end

exec :make_nupkg_code_doc_cecil do |cmd|
	asmVersion3 = extract_assembly_version "./CommonAssemblyInfo.cs"
	puts "Version: #{asmVersion3}"
	cecilVersion = extract_cecil_version "./src/DandyDoc.CodeDoc.Cecil/packages.config"
	puts "Cecil Version: #{cecilVersion}"
	cmd.command = "./.nuget/nuget.exe"
	cmd.parameters = "pack build/DandyDoc.CodeDoc.Cecil.nuspec -Verbosity detailed -Version #{asmVersion3} -Symbols -OutputDirectory ./build/packed/ -Properties Configuration=Release;cecilVersion=#{cecilVersion}"
end

exec :push_nupkg_code_doc_cecil do |cmd|
	asmVersion3 = extract_assembly_version "./CommonAssemblyInfo.cs"
	puts "Version: #{asmVersion3}"
	cmd.command = "./.nuget/nuget.exe"
	cmd.parameters = "push build/packed/DandyDoc.CodeDoc.Cecil.#{asmVersion3}.nupkg"
	puts cmd.parameters
end